#!/usr/bin/env python
# -*- coding: utf-8 -*-

def advanced_fix():
    # 从最初的原始文件开始处理
    original_file = r'C:\Onedrive\Work\ICBC\报告\常规报告\量化月报\月度量化预测模型\模型\预测黄金\predict_classification_gold.py'
    
    # 直接读取原始二进制内容，然后使用正确的编码解码
    with open(original_file, 'rb') as f:
        raw_bytes = f.read()
    
    # 尝试不同的编码方式
    encodings = ['gb2312', 'gbk', 'utf-8']
    
    for encoding in encodings:
        try:
            content = raw_bytes.decode(encoding)
            print(f"成功使用 {encoding} 解码")
            
            # 使用上下文修复特定的乱码
            fixes = {
                # 机器学习相关
                'DecisionTreeClassifier  # 鍐崇瓥锟?': 'DecisionTreeClassifier  # 决策树',
                'RandomForestClassifier  # 闅忔満妫鏋': 'RandomForestClassifier  # 随机森林',
                
                # 数据相关
                '璁缁冩暟鎹锟?xlsx': '训练数据.xlsx',
                '璇诲彇璺寰勪笅璁缁冩暟锟?': '读取路径下训练数据',
                '涓嬩竴鏈熼粍閲戜环锟?': '下一期黄金价格',
                '涓嬩竴鏈熸椂锟?': '下一期时间',
                '鍚勫洜瀛愭暟鎹锛堣緭鍏ュ彉閲忥拷?': '各因子数据（输入变量）',
                
                # 计算相关
                '璁＄畻娑ㄨ穼锟?': '计算涨跌幅',
                '瀹氫箟鏍囩惧垝鍒嗗嚱鏁': '定义标签划分函数',
                '鏀剁泭锟?%鍒嗕綅鏁颁綔涓轰笅锟?': '收益1%分位数作为下界',
                '鏀剁泭锟?9%鍒嗕綅鏁颁綔涓轰笂锟?': '收益99%分位数作为上界',
                '鏀剁泭鐜囧尯闂村垝锟?': '收益率区间划分',
                '鎵撲笂鍒嗙被鏍囩': '打上分类标签',
                
                # 数据集相关
                '鑾峰彇鏍囩俱佹敹鐩婄巼鍖洪棿': '获取标签、收益率区间',
                '鍙鍚缁忔祹鏁版嵁': '只含经济数据',
                '鍙鍚甯傚満鏁版嵁': '只含市场数据',
                '棰勬祴鏈熸暟': '预测期数',
                '棰勬祴闆嗙粨鏉熸湡锟?': '预测集结束期数',
                '棰勬祴锟?': '预测值',
                '棰勮祴闆嗗綋鏈熶环锟?': '预测集当期价格',
                '棰勬祴闆嗕笅鏈熶环锟?': '预测集下期价格',
                '璁缁冮泦鏃堕暱k锟?': '训练集时长k数',
                '璁缁冩椂闀夸负棰勬祴鏃剁偣鍓嶆帹k锟?': '训练时长为预测时点前推k数',
                
                # 模型相关
                '浠ヤ俊鎭澧炵泭浣滀负鍒ゆ柇鏉★拷?': '以信息增益作为判断条件',
                '棰勬祴姒傜巼': '预测概率',
                '鍑嗙‘锟?': '准确率',
                
                # 其他术语
                '绱绉姒傜巼鍒嗗竷鍑芥暟': '累积概率分布函数',
                '璁＄畻绱绉姒傜巼鍒嗗竷': '计算累积概率分布',
                '绱绉姒傜巼锟?.5宸︿晶鐨勪綅锟?': '累积概率0.5左侧的位置',
                '绱绉姒傜巼锟?.5鍙充晶鐨勪綅锟?': '累积概率0.5右侧的位置',
                '鏀剁泭鐜囧尯闂翠腑锟?': '收益率区间中点',
                '姹傞勬祴鏀剁泭鐜囦腑浣嶥?': '求预测收益率中位数',
                '姹傞勬祴鏀剁泭鐜囧潎锟?': '求预测收益率均值',
                '姹傞勬祴浠锋牸鍧囷拷?': '求预测价格均值',
                
                # 百分位数相关
                '绱绉姒傜巼锟?.05宸︿晶鐨勪綅锟?': '累积概率0.05左侧的位置',
                '绱绉姒傜巼锟?.95宸︿晶鐨勪綅锟?': '累积概率0.95左侧的位置',
                '绱绉姒傜巼锟?.1宸︿晶鐨勪綅锟?': '累积概率0.1左侧的位置',
                '绱绉姒傜巼锟?.9宸︿晶鐨勪綅锟?': '累积概率0.9左侧的位置',
                '绱绉姒傜巼锟?.25宸︿晶鐨勪綅锟?': '累积概率0.25左侧的位置',
                '绱绉姒傜巼锟?.75宸︿晶鐨勪綅锟?': '累积概率0.75左侧的位置',
                '绱绉姒傜巼锟?.16宸︿晶鐨勪綅锟?': '累积概率0.16左侧的位置',
                '绱绉姒傜巼锟?.84宸︿晶鐨勪綅锟?': '累积概率0.84左侧的位置',
                
                # 特定百分位数
                '姹傞勬祴鏀剁泭鐜10%鍒嗕綅锟?': '求预测收益率10%分位数',
                '姹傞勬祴鏀剁泭鐜90%鍒嗕綅锟?': '求预测收益率90%分位数',
                '姹傞勬祴鏀剁泭鐜25%鍒嗕綅锟?': '求预测收益率25%分位数',
                '姹傞勬祴鏀剁泭鐜75%鍒嗕綅锟?': '求预测收益率75%分位数',
                '姹傞勬祴鏀剁泭鐜16%鍒嗕綅锟?': '求预测收益率16%分位数',
                '姹傞勬祴鏀剁泭鐜84%鍒嗕綅锟?': '求预测收益率84%分位数',
                '姹傞勬祴鏀剁泭鐜5%鍒嗕綅锟?': '求预测收益率5%分位数',
                '姹傞勬祴鏀剁泭鐜95%鍒嗕綅锟?': '求预测收益率95%分位数',
                
                # 其他统计术语
                '棰勬祴绯绘暟锛堟ā鍨嬪氶噸绯绘暟锛夐夊彇': '预测系数（模型倚重系数）选取',
                '璁＄畻棰勬祴鏀剁泭鐜囧垎甯冪殑鍧囧笺佹柟宸銆佸嘲搴︺佸亸锟?': '计算预测收益率分布的均值、方差、峰度、偏度',
            }
            
            # 应用修复
            for old, new in fixes.items():
                content = content.replace(old, new)
            
            # 保存修复后的文件
            output_file = r'C:\Dev\PythonBox\predict_classification_gold_advanced_fixed.py'
            with open(output_file, 'w', encoding='utf-8') as f:
                f.write(content)
            
            print(f"使用 {encoding} 编码解码并修复完成")
            print(f"文件已保存到: {output_file}")
            
            # 显示部分内容以验证修复结果
            with open(output_file, 'r', encoding='utf-8') as f:
                sample = f.read(1500)
                print("修复后文件内容预览:")
                print(sample[:800])
            
            return
            
        except UnicodeDecodeError:
            print(f"使用 {encoding} 解码失败")
            continue
    
    print("所有编码尝试都失败了")

if __name__ == "__main__":
    advanced_fix()