# 交易分析项目规格说明书

## 项目概述

本项目旨在开发一个股票交易分析系统，用于分析用户的A股交易记录，提供交易统计、盈亏分析、持仓管理等功能。

## 数据分析结果

### 数据源
- **文件**: `C:\Dev\PythonBox\temp\2023_2026_settlement.csv`
- **编码**: UTF-8
- **分隔符**: 空格（不定长）
- **时间范围**: 2023年5月19日 - 2025年12月30日
- **总记录数**: 约2410条

### 数据字段（19列）
| 字段名 | 数据类型 | 说明 |
|--------|----------|------|
| 交割日期 | 字符串 | 格式YYYYMMDD |
| 证券代码 | 字符串 | 6位股票代码 |
| 证券名称 | 字符串 | 股票简称 |
| 业务类型 | 字符串 | 交易类型 |
| 成交价格 | 浮点数 | 单价 |
| 成交数量 | 整数 | 股数 |
| 成交金额 | 浮点数 | 总金额 |
| 佣金 | 浮点数 | 券商佣金 |
| 印花税 | 浮点数 | 印花税（仅卖出） |
| 过户费 | 浮点数 | 过户费 |
| 清算费（B股） | 浮点数 | B股清算费 |
| 发生金额 | 浮点数 | 资金变动（负为支出） |
| 剩余金额 | 浮点数 | 账户余额 |
| 证券数量 | 整数 | 持仓数量 |
| 股东代码 | 字符串 | 股东账户号 |
| 币种 | 字符串 | 人民币/美元等 |
| 成交编号 | 字符串 | 交易编号 |
| 证券全称 | 字符串 | 完整名称 |
| 备注 | 字符串 | 附加说明 |

### 业务类型统计
| 业务类型 | 数量 | 说明 |
|----------|------|------|
| 证券买入 | 868 | 股票买入 |
| 证券卖出 | 664 | 股票卖出 |
| 融券回购 | 416 | 国债逆回购（出借） |
| 融券购回 | 416 | 国债逆回购到期 |
| 银行转证券 | 若干 | 资金转入 |
| 证券转银行 | 若干 | 资金转出 |
| 利息归本 | 若干 | 利息收入 |
| 红利入账 | 若干 | 股息收入 |
| 股息红利差异扣税 | 若干 | 红利税补扣 |
| 红股入账 | 若干 | 送股 |
| 指定交易 | 1 | 账户指定 |

## 数据质量问题

### 1. 格式问题
- 文件使用不定长空格分隔，需要特殊解析
- 部分行有引号包裹（如备注字段）
- 第一行为分隔线，第二行为表头

### 2. 缺失值问题
| 业务类型 | 缺失字段 |
|----------|----------|
| 银行转证券 | 证券代码、证券名称、股东代码等 |
| 证券转银行 | 同上 |
| 利息归本 | 证券代码、证券名称等 |
| 红利入账 | 部分字段可能为空 |
| 股息红利差异扣税 | 部分字段可能为空 |

### 3. 数据类型问题
- 日期字段为字符串，需转换为日期类型
- 数值字段可能包含空格，需清理
- 成交数量可能为浮点数（如ETF）

### 4. 特殊情况
- 同一证券可能有多个股东代码（A股、科创板等）
- 国债逆回购代码：131810（R-001）、204001（GC001）等
- ETF基金代码：159xxx（深市）、51xxxx（沪市）

## 项目目录结构

```
PythonBox/
└── trade_analysis/              # 交易分析项目
    ├── data/                    # 数据目录
    │   ├── raw/                 # 原始数据
    │   │   └── settlement.csv   # 结算数据（复制自temp）
    │   └── processed/           # 处理后数据
    │       ├── cleaned_trades.csv      # 清洗后的交易数据
    │       ├── positions.csv           # 持仓数据
    │       └── summary.csv             # 汇总数据
    ├── models/                  # 分析模型
    │   ├── __init__.py
    │   ├── data_cleaner.py      # 数据清洗模型
    │   ├── position_tracker.py  # 持仓追踪模型
    │   ├── profit_calculator.py # 盈亏计算模型
    │   └── report_generator.py  # 报告生成模型
    ├── tools/                   # 工具模块
    │   ├── __init__.py
    │   ├── data_loader.py       # 数据加载工具
    │   ├── visualization.py     # 可视化工具
    │   └── export_utils.py      # 导出工具
    ├── scripts/                 # 运行脚本
    │   ├── analyze_trades.py    # 主分析脚本
    │   └── generate_report.py   # 报告生成脚本
    ├── tests/                   # 测试代码
    │   ├── __init__.py
    │   └── test_data_cleaner.py
    ├── .trae/                   # Trae配置
    │   └── documents/           # 项目文档
    ├── README.md                # 项目说明
    └── requirements.txt         # 依赖配置
```

## 核心功能模块

### 1. 数据清洗模块 (data_cleaner.py)
- 解析CSV文件（处理空格分隔）
- 处理缺失值（根据业务类型填充默认值）
- 转换数据类型（日期、数值）
- 标准化字段名称
- 输出清洗后的数据

### 2. 持仓追踪模块 (position_tracker.py)
- 追踪每只股票的持仓变化
- 计算加权平均成本
- 处理送股、配股等特殊情况
- 计算当前持仓状态

### 3. 盈亏计算模块 (profit_calculator.py)
- 计算已实现盈亏
- 计算交易费用统计
- 计算国债逆回购收益
- 计算股息收入
- 按股票/按时间统计盈亏

### 4. 报告生成模块 (report_generator.py)
- 生成交易汇总报告
- 生成持仓报告
- 生成盈亏报告
- 导出Excel格式

### 5. 可视化工具 (visualization.py)
- 资金曲线图
- 盈亏分布图
- 持仓占比饼图
- 交易频率热力图

## 用户确认结果

### 问题1：持仓成本计算方法
- **已选择**: FIFO先进先出法
- **说明**: 先买入的股票先卖出，适合精确计算每笔交易盈亏

### 问题2：是否需要实时市价数据
- **已选择**: 仅使用历史交易数据
- **说明**: 不集成第三方API，仅分析历史交易记录

### 问题3：报告输出格式
- **已选择**: 全部支持
- **说明**: 控制台输出 + Excel文件 + HTML报告

### 问题4：分析粒度
- **已选择**: 以上全部
- **说明**: 支持按股票、日期、月份多维度分析

### 问题5：是否需要区分交易账户
- **已选择**: 合并分析
- **说明**: 两个股东代码（A841731132、0022693339）合并为一个账户分析

## 技术栈
- Python 3.13
- pandas: 数据处理
- numpy: 数值计算
- matplotlib/seaborn: 可视化
- openpyxl: Excel导出
- jinja2: HTML报告模板（可选）

## 后续扩展
- 支持导入多券商数据
- 添加技术指标分析
- 集成量化策略回测
- 添加风险管理模块
